<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lista Smart Pro">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100'/><text y='75' font-size='80' fill='white'>üõí</text></svg>">
    <title>Lista Smart Pro - AI Enhanced</title>
    
    <!-- Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196F3;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border: #e0e0e0;
            --shadow: rgba(0,0,0,0.1);
            --header-height: 170px;
        }

        [data-theme="dark"] {
            --primary: #8b9fea;
            --secondary: #9468b2;
            --success: #66bb6a;
            --danger: #ef5350;
            --warning: #ffa726;
            --info: #42a5f5;
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border: #404040;
            --shadow: rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: var(--bg-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .header-stats {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255,255,255,0.15);
            padding: 6px 10px;
            border-radius: 8px;
            min-width: 60px;
        }

        .header-stat-number {
            font-size: 1.1em;
            font-weight: bold;
        }

        .header-stat-label {
            font-size: 0.65em;
            opacity: 0.9;
            margin-top: 2px;
        }

        .pro-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.5em;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            touch-action: manipulation;
            position: relative;
        }

        .icon-btn:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
        }

        .icon-btn .badge-dot {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: #ff4444;
            border-radius: 50%;
            border: 2px solid white;
        }

        .tabs {
            display: flex;
            gap: 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 5px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 10px 15px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            touch-action: manipulation;
            white-space: nowrap;
        }

        .tab.active {
            background: rgba(255,255,255,0.3);
            color: white;
            font-weight: bold;
        }

        .search-bar-container {
            margin-top: 12px;
            width: 100%;
        }

        .search-bar {
            width: 100%;
            padding: 12px 16px;
            padding-left: 45px;
            border: none;
            border-radius: 12px;
            background: rgba(255,255,255,0.95);
            color: var(--text-primary);
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .search-bar:focus {
            outline: none;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .search-bar::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.1em;
            pointer-events: none;
        }

        .search-wrapper {
            position: relative;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px;
        }

        /* Enhanced Stats with Budget */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 5px var(--shadow);
            transition: transform 0.3s;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .budget-card {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--success) 0%, #66bb6a 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .budget-info h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .budget-amount {
            font-size: 2em;
            font-weight: bold;
        }

        .budget-progress {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .budget-progress-bar {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* AI Suggestions Panel */
        .ai-suggestions {
            background: linear-gradient(135deg, var(--info) 0%, #42a5f5 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .ai-icon {
            font-size: 1.5em;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .ai-title {
            font-weight: bold;
            font-size: 1.1em;
        }

        .suggestion-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .suggestion-chip {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            border: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .suggestion-chip:active {
            background: rgba(255,255,255,0.4);
            transform: scale(0.95);
        }

        /* Product with Price and Store */
        .category {
            margin-bottom: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-primary);
            border-bottom: 2px solid var(--primary);
        }

        .category-name {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-primary);
            flex: 1;
        }

        .category-stats {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-right: 10px;
        }

        .category-controls {
            display: flex;
            gap: 5px;
        }

        .small-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2em;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .small-btn:active {
            background: var(--border);
        }

        .products-list {
            padding: 10px;
        }

        .product-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            grid-template-rows: auto auto;
            gap: 10px;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 2px solid transparent;
            position: relative;
            transition: all 0.3s;
            touch-action: pan-y;
        }

        .product-item.dragging {
            opacity: 0.5;
            border-color: var(--primary);
        }

        .product-item.drag-over {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }

        .product-checkbox {
            grid-row: 1 / 3;
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .product-info {
            grid-column: 2;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .product-name {
            font-size: 1em;
            font-weight: 500;
            color: var(--text-primary);
        }

        .product-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .product-price {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .product-store {
            background: rgba(33, 150, 243, 0.1);
            color: var(--info);
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.85em;
        }

        .product-barcode {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning);
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-family: monospace;
        }

        .product-actions {
            grid-column: 3;
            grid-row: 1 / 3;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .action-btn {
            background: var(--bg-secondary);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .delete-btn {
            grid-column: 4;
            grid-row: 1 / 3;
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1.5em;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .delete-btn:active {
            background: rgba(244, 67, 54, 0.1);
        }

        /* Scanner Interface */
        .scanner-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow);
        }

        #reader {
            width: 100%;
            border: none;
        }

        .scanner-controls {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: var(--bg-secondary);
        }

        .scanner-result {
            background: var(--success);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Templates Grid */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .template-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            text-align: center;
            touch-action: manipulation;
        }

        .template-card:active {
            transform: scale(0.98);
            border-color: var(--primary);
        }

        .template-card.featured {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .template-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .template-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .template-desc {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .template-count {
            font-size: 0.8em;
            margin-top: 5px;
            opacity: 0.7;
        }

        /* Store Management */
        .stores-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .store-chip {
            background: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .store-chip.selected {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
        }

        .store-chip:active {
            transform: scale(0.95);
        }

        /* Shopping List Enhanced */
        .shopping-item {
            background: var(--bg-secondary);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 12px;
            align-items: center;
            box-shadow: 0 2px 5px var(--shadow);
            transition: all 0.3s;
        }

        .shopping-item.purchased {
            opacity: 0.6;
        }

        .shopping-item-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .shopping-item-name {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-primary);
        }

        .shopping-item.purchased .shopping-item-name {
            text-decoration: line-through;
        }

        .shopping-item-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .meta-tag {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 5px;
        }

        .qty-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .qty-btn:active {
            transform: scale(0.9);
        }

        /* FAB with Menu */
        .fab-menu {
            position: fixed;
            bottom: 90px;
            right: 20px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 89;
        }

        .fab-menu.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fab-option {
            background: white;
            color: var(--primary);
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 2px 10px var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            touch-action: manipulation;
            white-space: nowrap;
        }

        .fab-option:active {
            transform: scale(0.95);
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 2em;
            box-shadow: 0 4px 15px var(--shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 90;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .fab:active {
            transform: scale(0.95) rotate(45deg);
        }

        .fab.active {
            transform: rotate(45deg);
        }

        /* Modal Enhancements */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            width: 100%;
            max-height: 90vh;
            border-radius: 20px 20px 0 0;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            z-index: 10;
        }

        .modal-title {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--text-secondary);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            touch-action: manipulation;
        }

        .modal-close:active {
            background: var(--border);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1em;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-scan {
            background: linear-gradient(135deg, var(--warning) 0%, #ffa726 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.2em;
        }

        /* Settings Items */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .templates-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--border) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* TRACKER STYLES */
        .complete-shopping-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--success) 0%, #66bb6a 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.8em;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 89;
            touch-action: manipulation;
        }

        .complete-shopping-btn:active {
            transform: scale(0.95);
        }

        .complete-shopping-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }

        .history-item {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
            box-shadow: 0 2px 5px var(--shadow);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .history-date {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.95em;
        }

        .history-total {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--success);
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .history-stat {
            text-align: center;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .history-stat-number {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary);
        }

        .history-stat-label {
            font-size: 0.75em;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .history-products {
            margin-top: 10px;
        }

        .history-category {
            margin-bottom: 10px;
        }

        .history-category-title {
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 5px;
            padding: 5px 10px;
            background: var(--bg-primary);
            border-radius: 6px;
        }

        .history-product {
            padding: 8px 10px;
            background: var(--bg-primary);
            border-radius: 6px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-product-name {
            flex: 1;
            font-size: 0.9em;
        }

        .history-product-price {
            font-weight: bold;
            color: var(--success);
            font-size: 0.9em;
        }

        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .btn-icon {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .btn-icon:active {
            transform: scale(0.95);
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .btn-reorder {
            background: var(--primary);
            color: white;
        }

        .empty-history {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-history-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .filter-tab {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            font-size: 0.85em;
            touch-action: manipulation;
        }

        .filter-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-tab:active {
            transform: scale(0.95);
        }

        /* Search Bar - FREEZE sub header */

        .search-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.1em;
            pointer-events: none;
        }

        /* Lists Management */
        .lists-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        .list-dropdown {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
        }

        .list-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .list-btn:active {
            transform: scale(0.95);
        }

        .highlight {
            background-color: rgba(255, 235, 59, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            :root {
                --header-height: 130px;
            }
            
            .header h1 {
                font-size: 1.1em;
            }
            
            .header-stats {
                gap: 8px;
            }
            
            .header-stat {
                min-width: 50px;
                padding: 5px 8px;
            }
            
            .header-stat-number {
                font-size: 1em;
            }
            
            .header-stat-label {
                font-size: 0.6em;
            }
            
            .pro-badge {
                font-size: 0.45em;
            }
        }

        @media (max-width: 480px) {
            :root {
                --header-height: 150px;
            }
            
            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .header h1 {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="header-left">
                    <h1>
                        üõí <span id="currentListName">Lista Smart</span>
                        <span class="pro-badge">PRO</span>
                    </h1>
                    <div class="header-stats">
                        <div class="header-stat">
                            <div class="header-stat-number" id="totalProductsHeader">0</div>
                            <div class="header-stat-label">Produse</div>
                        </div>
                        <div class="header-stat">
                            <div class="header-stat-number" id="categoriesCountHeader">0</div>
                            <div class="header-stat-label">Categorii</div>
                        </div>
                        <div class="header-stat">
                            <div class="header-stat-number" id="totalValueHeader">0</div>
                            <div class="header-stat-label">Valoare</div>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="openAISuggestions()" title="AI Sugestii">
                        ü§ñ
                        <span class="badge-dot" id="aiNotification" style="display: none;"></span>
                    </button>
                    <button class="icon-btn" onclick="openShareModal()" title="Distribuie">üì§</button>
                    <button class="icon-btn" onclick="openSettingsModal()" title="SetƒÉri">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="tabs">
                <button class="tab active" data-tab="products" onclick="switchTab('products')">
                    üì¶ Produse
                </button>
                <button class="tab" data-tab="shopping" onclick="switchTab('shopping')">
                    üõçÔ∏è Lista <span class="badge" id="cartBadge">0</span>
                </button>
                <button class="tab" data-tab="history" onclick="switchTab('history')">
                    üìä Istoric
                </button>
                <button class="tab" data-tab="templates" onclick="switchTab('templates')">
                    üìã Template
                </button>
            </div>
            
            <!-- Search Bar in Header -->
            <div class="search-bar-container">
                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" class="search-bar" placeholder="CautƒÉ produse..." oninput="searchProducts()">
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Tab Produse -->
            <div id="productsTab" class="tab-content">
                <!-- AI Suggestions -->
                <div id="aiSuggestionsPanel" class="ai-suggestions" style="display: none;">
                    <div class="ai-header">
                        <div class="ai-icon">ü§ñ</div>
                        <div>
                            <div class="ai-title">Sugestii AI</div>
                            <div style="font-size: 0.85em; opacity: 0.9;">Bazat pe istoricul tƒÉu</div>
                        </div>
                    </div>
                    <div class="suggestion-chips" id="suggestionChips"></div>
                </div>

                <div id="categoriesContainer"></div>
            </div>

            <!-- Tab Lista CumpƒÉrƒÉturi -->
            <div id="shoppingTab" class="tab-content" style="display: none;">
                <div class="budget-card">
                    <div class="budget-info">
                        <h3>Total Estimat</h3>
                        <div class="budget-amount" id="totalBudget">0 lei</div>
                        <div class="budget-progress">
                            <div class="budget-progress-bar" id="budgetProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-number" id="totalItems">0</div>
                        <div class="stat-label">Produse</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="purchasedItems">0</div>
                        <div class="stat-label">CumpƒÉrate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="remainingItems">0</div>
                        <div class="stat-label">RƒÉmase</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="storesCount">0</div>
                        <div class="stat-label">Magazine</div>
                    </div>
                </div>

                <!-- Filter by Store -->
                <div class="stores-list" id="storesFilter"></div>

                <div id="shoppingList"></div>
                
                <!-- Complete Shopping Button - shown only in shopping tab -->
                <button class="complete-shopping-btn" id="completeShoppingBtn" onclick="completeShoppingTrip()" title="FinalizeazƒÉ cumpƒÉrƒÉturile" style="display: none;">
                    ‚úì
                </button>
            </div>

            <!-- Tab Istoric -->
            <div id="historyTab" class="tab-content" style="display: none;">
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterHistory('all')">Toate</button>
                    <button class="filter-tab" onclick="filterHistory('week')">SƒÉptƒÉm√¢na asta</button>
                    <button class="filter-tab" onclick="filterHistory('month')">Luna asta</button>
                    <button class="filter-tab" onclick="filterHistory('year')">Anul acesta</button>
                </div>

                <div id="historyList"></div>
            </div>

            <!-- Tab Templates -->
            <div id="templatesTab" class="tab-content" style="display: none;">
                <div class="empty-state" style="margin-bottom: 30px;">
                    <div class="empty-state-icon">üìã</div>
                    <div class="empty-state-text">Alege un template pentru a crea rapid o listƒÉ</div>
                </div>
                <div class="templates-grid" id="templatesContainer"></div>
            </div>

            <!-- Tab Scanner -->
        </div>

        <!-- FAB Menu -->
        <div class="fab-menu" id="fabMenu">
            <div class="fab-option" onclick="openProductModal(-1)">
                <span>‚ûï</span>
                <span>Produs Nou</span>
            </div>
            <div class="fab-option" onclick="openCategoryModal()">
                <span>üìÅ</span>
                <span>Categorie NouƒÉ</span>
            </div>
            <div class="fab-option" id="deselectAllFabOption" onclick="deselectAllProducts(); toggleFabMenu();" style="display: none;">
                <span>‚Ü©Ô∏è</span>
                <span>Deselect All</span>
            </div>
        </div>

        <button class="fab" id="mainFab" onclick="toggleFabMenu()">+</button>
    </div>

    <!-- Modal Add/Edit Product (Enhanced) -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">AdaugƒÉ Produs</div>
                <button class="modal-close" onclick="closeProductModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Product Image Preview -->
                <div id="productImagePreview" style="display: none; text-align: center; margin-bottom: 20px;">
                    <img id="productImage" src="" alt="Produs" style="max-width: 200px; max-height: 200px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                    <div style="margin-top: 10px; font-size: 0.9em; color: var(--success);">‚úÖ Produs recunoscut automat</div>
                </div>
                
                <div class="form-group">
                    <label>Nume Produs:</label>
                    <input type="text" id="productName" placeholder="Ex: Lapte">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Pre»õ (Lei):</label>
                        <input type="number" id="productPrice" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Cantitate:</label>
                        <input type="number" id="productQuantity" placeholder="1" value="1" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>Categorie:</label>
                    <select id="productCategory"></select>
                </div>

                <div class="form-group">
                    <label>Magazin Preferat:</label>
                    <select id="productStore">
                        <option value="">SelecteazƒÉ magazin</option>
                        <option value="Kaufland">Kaufland</option>
                        <option value="Lidl">Lidl</option>
                        <option value="Carrefour">Carrefour</option>
                        <option value="Mega Image">Mega Image</option>
                        <option value="Auchan">Auchan</option>
                        <option value="Penny">Penny</option>
                        <option value="Profi">Profi</option>
                        <option value="Altul">Altul (manual)</option>
                    </select>
                </div>

                <div class="form-group" id="customStoreGroup" style="display: none;">
                    <label>Nume Magazin:</label>
                    <input type="text" id="customStore" placeholder="Ex: Piata locala">
                </div>

                <button class="btn btn-primary" onclick="addNewProduct()">‚úÖ AdaugƒÉ Produs</button>
            </div>
        </div>
    </div>

    <!-- Modal Category -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">AdaugƒÉ Categorie</div>
                <button class="modal-close" onclick="closeCategoryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nume Categorie:</label>
                    <input type="text" id="categoryName" placeholder="Ex: Lactate">
                </div>
                <button class="btn btn-primary" onclick="addNewCategory()">AdaugƒÉ</button>
            </div>
        </div>
    </div>

    <!-- Modal Move Product -->
    <div id="moveProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">MutƒÉ Produs</div>
                <button class="modal-close" onclick="closeMoveProductModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>SelecteazƒÉ Categoria NouƒÉ:</label>
                    <select id="newCategorySelect"></select>
                </div>
                <button class="btn btn-primary" onclick="confirmMoveProduct()">MutƒÉ Produsul</button>
            </div>
        </div>
    </div>

    <!-- Modal AI Suggestions -->
    <div id="aiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ü§ñ Sugestii Inteligente</div>
                <button class="modal-close" onclick="closeAIModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="ai-suggestions" style="margin-bottom: 20px;">
                    <p style="margin-bottom: 15px;">Bazat pe istoricul tƒÉu de cumpƒÉrƒÉturi, √Æ»õi sugerez:</p>
                    <div id="aiDetailedSuggestions"></div>
                </div>
                <button class="btn btn-primary" onclick="addAllSuggestions()">‚úÖ AdaugƒÉ Toate Sugestiile</button>
            </div>
        </div>
    </div>

    <!-- Modal Settings -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">SetƒÉri</div>
                <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="settings-item">
                    <div class="settings-label">üåô Mod √éntunecat</div>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <div class="settings-label">ü§ñ Sugestii AI</div>
                    <label class="switch">
                        <input type="checkbox" id="aiToggle" checked onchange="toggleAI()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <div class="settings-label">üîî NotificƒÉri</div>
                    <label class="switch">
                        <input type="checkbox" id="notificationsToggle" onchange="toggleNotifications()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <div class="settings-label">üí∞ Afi»ôare Pre»õuri</div>
                    <label class="switch">
                        <input type="checkbox" id="pricesToggle" checked onchange="togglePrices()">
                        <span class="slider"></span>
                    </label>
                </div>
                <button class="btn btn-secondary" onclick="exportData()">üì• Export Date Complete</button>
                <button class="btn btn-secondary" onclick="importData()">üì§ Import Date Complete</button>
                <button class="btn btn-primary" onclick="exportProducts()">üìã Export Lista Produse</button>
                <button class="btn btn-primary" onclick="importProducts()">üìã Import Lista Produse</button>
                <button class="btn btn-secondary" onclick="clearHistory()">üóëÔ∏è »òterge Istoric</button>
            </div>
        </div>
    </div>

    <!-- Modal Share -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Distribuie Lista</div>
                <button class="modal-close" onclick="closeShareModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Link de sincronizare:</label>
                    <input type="text" id="shareLink" readonly>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="copyShareLink()" style="flex: 1;">
                            üìã CopiazƒÉ Link
                        </button>
                        <button class="btn btn-secondary" id="shortenBtn" onclick="shortenLink()" style="flex: 1;">
                            ‚úÇÔ∏è ScurteazƒÉ Link
                        </button>
                    </div>
                    <div id="shortenStatus" style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary); display: none;"></div>
                </div>
                <button class="btn btn-primary" onclick="shareViaWhatsApp()">üí¨ WhatsApp</button>
                <button class="btn btn-secondary" onclick="shareViaNative()">üì§ Alte Metode</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ==================== STATE MANAGEMENT ====================
        let currentListId = 'default';
        let currentTab = 'products';
        let selectedStoreFilter = null;
        let moveProductData = null;
        let html5QrcodeScanner = null;
        let scanningActive = false;

        // Predefined Templates
        const templates = [
            {
                id: 'saptamanal',
                name: 'SƒÉptƒÉm√¢nal',
                icon: 'üìÖ',
                description: 'Liste tipice pentru o sƒÉptƒÉm√¢nƒÉ',
                products: [
                    { name: 'P√¢ine', category: 'Panifica»õie', price: 3.5, store: 'Kaufland' },
                    { name: 'Lapte', category: 'Lactate', price: 6.5, store: 'Kaufland' },
                    { name: 'OuƒÉ (10 buc)', category: 'Lactate', price: 12, store: 'Kaufland' },
                    { name: 'Carne Pui', category: 'Carne', price: 15, store: 'Lidl' },
                    { name: 'Cartofi', category: 'Legume', price: 4, store: 'Kaufland' },
                    { name: 'Ro»ôii', category: 'Legume', price: 8, store: 'Kaufland' },
                    { name: 'ApƒÉ MineralƒÉ 6x2L', category: 'BƒÉuturi', price: 8, store: 'Lidl' }
                ]
            },
            {
                id: 'party',
                name: 'Petrecere',
                icon: 'üéâ',
                description: 'Pentru evenimente »ôi sƒÉrbƒÉtori',
                products: [
                    { name: 'Chips', category: 'Snacks', price: 5, store: 'Mega Image' },
                    { name: 'Pizza', category: 'Congelate', price: 18, store: 'Lidl' },
                    { name: 'Coca-Cola 2L', category: 'BƒÉuturi', price: 7, store: 'Kaufland' },
                    { name: 'Bere', category: 'BƒÉuturi', price: 25, store: 'Kaufland' },
                    { name: '√énghe»õatƒÉ', category: 'Desert', price: 12, store: 'Lidl' },
                    { name: 'Tort', category: 'Desert', price: 35, store: 'CofetƒÉrie' }
                ]
            },
            {
                id: 'breakfast',
                name: 'Mic Dejun',
                icon: 'üç≥',
                description: 'Produse pentru diminea»õƒÉ',
                products: [
                    { name: 'P√¢ine Toast', category: 'Panifica»õie', price: 4.5, store: 'Lidl' },
                    { name: 'Unt', category: 'Lactate', price: 8, store: 'Kaufland' },
                    { name: 'Br√¢nzƒÉ', category: 'Lactate', price: 12, store: 'Kaufland' },
                    { name: 'Cafea', category: 'BƒÉuturi', price: 15, store: 'Carrefour' },
                    { name: 'Cereale', category: 'Cereale', price: 10, store: 'Lidl' },
                    { name: 'Miere', category: 'Dulciuri', price: 18, store: 'Mega Image' }
                ]
            },
            {
                id: 'bbq',
                name: 'GrƒÉtar',
                icon: 'üçñ',
                description: 'Perfect pentru un BBQ',
                products: [
                    { name: 'Mici', category: 'Carne', price: 20, store: 'Lidl' },
                    { name: 'C√¢rna»õi', category: 'Carne', price: 18, store: 'Lidl' },
                    { name: 'Mu»ôtar', category: 'Condimente', price: 5, store: 'Kaufland' },
                    { name: 'Ketchup', category: 'Condimente', price: 6, store: 'Kaufland' },
                    { name: 'P√¢ine', category: 'Panifica»õie', price: 3, store: 'Kaufland' },
                    { name: 'SalatƒÉ Verde', category: 'Legume', price: 4, store: 'Kaufland' },
                    { name: 'Bere', category: 'BƒÉuturi', price: 25, store: 'Kaufland' }
                ]
            },
            {
                id: 'healthy',
                name: 'SƒÉnƒÉtos',
                icon: 'ü•ó',
                description: 'Produse sƒÉnƒÉtoase',
                products: [
                    { name: 'SalatƒÉ Mix', category: 'Legume', price: 8, store: 'Mega Image' },
                    { name: 'Avocado', category: 'Fructe', price: 12, store: 'Mega Image' },
                    { name: 'Piept Pui', category: 'Carne', price: 18, store: 'Lidl' },
                    { name: 'Quinoa', category: 'Cereale', price: 15, store: 'Carrefour' },
                    { name: 'Migdale', category: 'Nuts', price: 20, store: 'Kaufland' },
                    { name: 'Iaurt Grecesc', category: 'Lactate', price: 8, store: 'Lidl' }
                ]
            },
            {
                id: 'curatenie',
                name: 'CurƒÉ»õenie',
                icon: 'üßπ',
                description: 'Produse de curƒÉ»õenie',
                products: [
                    { name: 'Detergent Rufe', category: 'CurƒÉ»õenie', price: 15, store: 'Lidl' },
                    { name: 'Detergent Vase', category: 'CurƒÉ»õenie', price: 8, store: 'Kaufland' },
                    { name: 'Clor', category: 'CurƒÉ»õenie', price: 6, store: 'Penny' },
                    { name: 'H√¢rtie IgienicƒÉ', category: 'IgienƒÉ', price: 12, store: 'Lidl' },
                    { name: '»òerve»õele', category: 'IgienƒÉ', price: 8, store: 'Kaufland' },
                    { name: 'SƒÉpun', category: 'IgienƒÉ', price: 5, store: 'Kaufland' }
                ]
            }
        ];

        // ==================== SEARCH FUNCTIONALITY ====================
        window.searchProducts = function() {
            const input = document.getElementById('searchInput');
            searchQuery = input.value.toLowerCase().trim();
            renderCategories();
        };

        // ==================== LISTS MANAGEMENT ====================
        window.switchList = function() {
            // Nu mai e nevoie - am scos dropdown-ul
        };

        window.createNewList = function() {
            const name = prompt('Nume listƒÉ nouƒÉ:');
            if (!name || !name.trim()) return;
            
            const newId = Date.now().toString();
            lists[newId] = {
                name: name.trim(),
                categories: [],
                shoppingCart: []
            };
            
            currentListId = newId;
            document.getElementById('currentListName').textContent = lists[currentListId].name;
            saveData();
            clearSearch();
            renderCategories();
            renderShoppingList();
            
            alert(`‚úÖ Lista "${name}" a fost creatƒÉ »ôi activatƒÉ!`);
        };

        window.renameCurrentList = function() {
            const currentName = lists[currentListId].name;
            const newName = prompt('Nume nou pentru listƒÉ:', currentName);
            
            if (!newName || !newName.trim() || newName.trim() === currentName) return;
            
            lists[currentListId].name = newName.trim();
            document.getElementById('currentListName').textContent = lists[currentListId].name;
            saveData();
            
            alert(`‚úÖ Lista a fost redenumitƒÉ √Æn "${newName}"`);
        };

        window.deleteCurrentList = function() {
            if (Object.keys(lists).length === 1) {
                alert('‚ùå Nu po»õi »ôterge ultima listƒÉ!');
                return;
            }
            
            const listName = lists[currentListId].name;
            if (!confirm(`»òtergi lista "${listName}"?\n\nAceastƒÉ ac»õiune este permanentƒÉ!`)) {
                return;
            }
            
            delete lists[currentListId];
            
            // Switch to first available list
            currentListId = Object.keys(lists)[0];
            document.getElementById('currentListName').textContent = lists[currentListId].name;
            
            saveData();
            clearSearch();
            renderCategories();
            renderShoppingList();
            
            alert(`‚úÖ Lista "${listName}" a fost »ôtearsƒÉ!`);
        };

        let lists = {
            'default': {
                name: 'Lista PrincipalƒÉ',
                categories: [
                    {
                        name: "Lactate",
                        products: [
                            { name: "Lapte", price: 6.5, store: "Kaufland", barcode: "", excluded: false, quantity: 1 },
                            { name: "Br√¢nzƒÉ", price: 12, store: "Lidl", barcode: "", excluded: false, quantity: 1 },
                            { name: "Sm√¢nt√¢nƒÉ", price: 5, store: "Kaufland", barcode: "", excluded: false, quantity: 1 }
                        ]
                    },
                    {
                        name: "Carne & Pe»ôte",
                        products: [
                            { name: "Pui", price: 15, store: "Lidl", barcode: "", excluded: false, quantity: 1 },
                            { name: "Porc", price: 20, store: "Kaufland", barcode: "", excluded: false, quantity: 1 }
                        ]
                    },
                    {
                        name: "Legume & Fructe",
                        products: [
                            { name: "Ro»ôii", price: 8, store: "Kaufland", barcode: "", excluded: false, quantity: 1 },
                            { name: "Castrave»õi", price: 6, store: "Kaufland", barcode: "", excluded: false, quantity: 1 },
                            { name: "Banane", price: 7, store: "Lidl", barcode: "", excluded: false, quantity: 1 }
                        ]
                    }
                ],
                shoppingCart: []
            }
        };

        let purchaseHistory = [];
        let shoppingTrips = []; // NEW: tracking pentru ture complete de cumpƒÉrƒÉturi
        let settings = {
            darkMode: false,
            aiEnabled: true,
            notifications: false,
            showPrices: true
        };
        let currentHistoryFilter = 'all'; // NEW: filter pentru istoric
        let searchQuery = ''; // NEW: search query

        // ==================== AI SUGGESTIONS SYSTEM ====================
        function analyzeShoppingPatterns() {
            if (!settings.aiEnabled) return [];
            
            const now = new Date();
            const dayOfWeek = now.getDay();
            const suggestions = [];

            // Analyze purchase frequency
            const productFrequency = {};
            purchaseHistory.forEach(item => {
                const key = item.product;
                if (!productFrequency[key]) {
                    productFrequency[key] = { count: 0, lastPurchase: null, avgDays: 0 };
                }
                productFrequency[key].count++;
                productFrequency[key].lastPurchase = new Date(item.date);
            });

            // Generate suggestions based on patterns
            Object.keys(productFrequency).forEach(product => {
                const data = productFrequency[product];
                if (data.count >= 3) {
                    const daysSinceLastPurchase = Math.floor((now - data.lastPurchase) / (1000 * 60 * 60 * 24));
                    if (daysSinceLastPurchase >= 7) {
                        suggestions.push({
                            product: product,
                            reason: 'CumpƒÉrat frecvent',
                            confidence: Math.min(data.count / 10, 1)
                        });
                    }
                }
            });

            // Day-based suggestions
            if (dayOfWeek === 5 || dayOfWeek === 6) {
                suggestions.push({ product: 'P√¢ine', reason: 'Weekend', confidence: 0.8 });
                suggestions.push({ product: 'Bere', reason: 'Weekend', confidence: 0.6 });
            }

            return suggestions.slice(0, 5);
        }

        function showAISuggestions() {
            const suggestions = analyzeShoppingPatterns();
            if (suggestions.length === 0) return;

            const panel = document.getElementById('aiSuggestionsPanel');
            const chips = document.getElementById('suggestionChips');
            const notification = document.getElementById('aiNotification');

            chips.innerHTML = '';
            suggestions.forEach(sug => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.innerHTML = `
                    <span>‚ú®</span>
                    <span>${sug.product}</span>
                    <span style="font-size: 0.8em; opacity: 0.8;">(${Math.round(sug.confidence * 100)}%)</span>
                `;
                chip.onclick = () => quickAddProduct(sug.product);
                chips.appendChild(chip);
            });

            panel.style.display = 'block';
            notification.style.display = 'block';
        }

        function quickAddProduct(productName) {
            // Find product in categories and add to cart
            lists[currentListId].categories.forEach(cat => {
                const product = cat.products.find(p => p.name === productName);
                if (product && !isInCart(cat.name, productName)) {
                    toggleProduct(cat.name, productName, true);
                }
            });
            renderShoppingList();
        }

        window.openAISuggestions = function() {
            document.getElementById('aiModal').classList.add('active');
            const container = document.getElementById('aiDetailedSuggestions');
            const suggestions = analyzeShoppingPatterns();
            
            container.innerHTML = '';
            suggestions.forEach(sug => {
                const div = document.createElement('div');
                div.className = 'suggestion-chip';
                div.innerHTML = `
                    <strong>${sug.product}</strong>
                    <span style="opacity: 0.8; font-size: 0.85em;">${sug.reason}</span>
                `;
                div.onclick = () => {
                    quickAddProduct(sug.product);
                    div.style.opacity = '0.5';
                };
                container.appendChild(div);
            });
        };

        window.closeAIModal = function() {
            document.getElementById('aiModal').classList.remove('active');
        };

        window.addAllSuggestions = function() {
            const suggestions = analyzeShoppingPatterns();
            suggestions.forEach(sug => quickAddProduct(sug.product));
            closeAIModal();
        };

        // ==================== BARCODE SCANNER ====================
        window.startScanner = function() {
            if (scanningActive) return;
            
            const html5QrCode = new Html5Qrcode("reader");
            html5QrcodeScanner = html5QrCode;
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText, decodedResult) => {
                    onBarcodeScanned(decodedText);
                },
                (errorMessage) => {
                    // Scan error, ignore
                }
            ).then(() => {
                scanningActive = true;
                document.getElementById('startScanBtn').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'block';
            }).catch(err => {
                alert('Nu am putut accesa camera: ' + err);
            });
        };

        window.stopScanner = function() {
            if (html5QrcodeScanner && scanningActive) {
                html5QrcodeScanner.stop().then(() => {
                    scanningActive = false;
                    document.getElementById('startScanBtn').style.display = 'block';
                    document.getElementById('stopScanBtn').style.display = 'none';
                });
            }
        };

        function onBarcodeScanned(barcode) {
            stopScanner();
            
            const resultDiv = document.getElementById('scannerResult');
            resultDiv.className = 'scanner-result';
            resultDiv.innerHTML = `
                <strong>üîç Scanat:</strong> ${barcode}<br>
                <div style="margin-top: 10px;">‚è≥ CƒÉutare produs...</div>
            `;
            resultDiv.style.display = 'block';

            // Search OpenFoodFacts API
            searchProductByBarcode(barcode);
        }

        async function searchProductByBarcode(barcode) {
            try {
                // Check cache first
                const cacheKey = `product_${barcode}`;
                const cached = localStorage.getItem(cacheKey);
                
                if (cached) {
                    const productData = JSON.parse(cached);
                    showProductResult(barcode, productData, true);
                    return;
                }
                
                // Call OpenFoodFacts API
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1 && data.product) {
                    const product = data.product;
                    
                    // Extract product info
                    const productData = {
                        name: product.product_name || product.generic_name || 'Produs necunoscut',
                        brand: product.brands || '',
                        category: extractCategory(product.categories_tags || product.categories || ''),
                        quantity: product.quantity || '',
                        image: product.image_url || product.image_front_url || '',
                        barcode: barcode
                    };
                    
                    // Cache the result
                    localStorage.setItem(cacheKey, JSON.stringify(productData));
                    
                    showProductResult(barcode, productData, false);
                } else {
                    // Product not found
                    showProductResult(barcode, null, false);
                }
            } catch (error) {
                console.error('Error fetching product:', error);
                showProductResult(barcode, null, false);
            }
        }

        function extractCategory(categoriesString) {
            if (!categoriesString) return '';
            
            // OpenFoodFacts categories are in format: "en:beverages, en:milk, en:dairy"
            const categories = categoriesString.toString().toLowerCase();
            
            // Map to Romanian categories
            const categoryMap = {
                'milk': 'Lactate',
                'dairy': 'Lactate',
                'cheese': 'Lactate',
                'yogurt': 'Lactate',
                'beverage': 'BƒÉuturi',
                'water': 'BƒÉuturi',
                'juice': 'BƒÉuturi',
                'soda': 'BƒÉuturi',
                'meat': 'Carne & Pe»ôte',
                'fish': 'Carne & Pe»ôte',
                'chicken': 'Carne & Pe»ôte',
                'fruit': 'Legume & Fructe',
                'vegetable': 'Legume & Fructe',
                'bread': 'Panifica»õie',
                'bakery': 'Panifica»õie',
                'snack': 'Snacks',
                'chocolate': 'Dulciuri',
                'candy': 'Dulciuri',
                'cleaning': 'CurƒÉ»õenie',
                'hygiene': 'IgienƒÉ'
            };
            
            for (const [key, value] of Object.entries(categoryMap)) {
                if (categories.includes(key)) {
                    return value;
                }
            }
            
            return ''; // Will use default category
        }

        function showProductResult(barcode, productData, fromCache) {
            const resultDiv = document.getElementById('scannerResult');
            
            if (productData && productData.name && productData.name !== 'Produs necunoscut') {
                // Product found!
                resultDiv.innerHTML = `
                    <strong>‚úÖ Produs gƒÉsit${fromCache ? ' (din cache)' : ''}!</strong><br>
                    <div style="margin-top: 10px; font-weight: bold; color: var(--success);">
                        ${productData.brand ? productData.brand + ' - ' : ''}${productData.name}
                    </div>
                    <div style="margin-top: 5px; font-size: 0.9em;">
                        ${productData.quantity ? productData.quantity : ''}
                    </div>
                `;
            } else {
                // Product not found
                resultDiv.innerHTML = `
                    <strong>‚ö†Ô∏è Produs necunoscut</strong><br>
                    <div style="margin-top: 10px;">
                        Cod: ${barcode}<br>
                        Vei completa manual informa»õiile.
                    </div>
                `;
            }
            
            // Open modal after 1 second
            setTimeout(() => {
                openProductModalWithData(barcode, productData);
            }, 1000);
        }

        function openProductModalWithData(barcode, productData) {
            const modal = document.getElementById('productModal');
            const modalTitle = modal.querySelector('.modal-title');
            const imagePreview = document.getElementById('productImagePreview');
            const productImage = document.getElementById('productImage');
            
            editingProduct = null;
            modalTitle.textContent = 'AdaugƒÉ Produs';
            
            // Populate category dropdown
            const select = document.getElementById('productCategory');
            select.innerHTML = '';
            lists[currentListId].categories.forEach((cat, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = cat.name;
                select.appendChild(option);
            });
            
            if (productData && productData.name && productData.name !== 'Produs necunoscut') {
                // Product found - pre-fill data
                document.getElementById('productName').value = productData.brand ? 
                    `${productData.brand} ${productData.name}` : productData.name;
                document.getElementById('productBarcode').value = barcode;
                
                // Show image if available
                if (productData.image) {
                    productImage.src = productData.image;
                    imagePreview.style.display = 'block';
                } else {
                    imagePreview.style.display = 'none';
                }
                
                // Try to match category
                if (productData.category) {
                    const categoryIndex = lists[currentListId].categories.findIndex(
                        cat => cat.name.toLowerCase() === productData.category.toLowerCase()
                    );
                    
                    if (categoryIndex >= 0) {
                        select.value = categoryIndex;
                    } else {
                        // Create category if it doesn't exist
                        lists[currentListId].categories.push({
                            name: productData.category,
                            products: []
                        });
                        select.innerHTML = '';
                        lists[currentListId].categories.forEach((cat, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = cat.name;
                            select.appendChild(option);
                        });
                        select.value = lists[currentListId].categories.length - 1;
                    }
                }
                
                // Clear other fields
                document.getElementById('productPrice').value = '';
                document.getElementById('productQuantity').value = '1';
                document.getElementById('productStore').value = '';
                
            } else {
                // Product not found - clear all fields
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productQuantity').value = '1';
                document.getElementById('productBarcode').value = barcode;
                document.getElementById('productStore').value = '';
                imagePreview.style.display = 'none';
            }
            
            // Setup store select
            const storeSelect = document.getElementById('productStore');
            storeSelect.onchange = function() {
                const customGroup = document.getElementById('customStoreGroup');
                customGroup.style.display = this.value === 'Altul' ? 'block' : 'none';
            };
            document.getElementById('customStoreGroup').style.display = 'none';
            
            modal.classList.add('active');
            
            // Focus on price field if product was found, otherwise on name
            setTimeout(() => {
                if (productData && productData.name && productData.name !== 'Produs necunoscut') {
                    document.getElementById('productPrice').focus();
                } else {
                    document.getElementById('productName').focus();
                }
            }, 100);
        }

        window.scanBarcodeForProduct = function() {
            closeProductModal();
            switchTab('scanner');
            startScanner();
        };

        // ==================== TEMPLATES ====================
        function renderTemplates() {
            const container = document.getElementById('templatesContainer');
            container.innerHTML = '';

            templates.forEach(template => {
                const card = document.createElement('div');
                card.className = 'template-card';
                if (template.id === 'saptamanal') card.classList.add('featured');
                
                card.innerHTML = `
                    <div class="template-icon">${template.icon}</div>
                    <div class="template-name">${template.name}</div>
                    <div class="template-desc">${template.description}</div>
                    <div class="template-count">${template.products.length} produse</div>
                `;
                
                card.onclick = () => applyTemplate(template);
                container.appendChild(card);
            });
        }

        function applyTemplate(template) {
            if (!confirm(`Aplici template-ul "${template.name}" cu ${template.products.length} produse √Æn lista curentƒÉ?\n\nProdusele vor fi adƒÉugate √Æn lista: "${lists[currentListId].name}"`)) {
                return;
            }

            let addedProducts = 0;
            let addedCategories = 0;

            // Create categories if they don't exist
            template.products.forEach(prod => {
                let category = lists[currentListId].categories.find(c => c.name === prod.category);
                if (!category) {
                    category = { name: prod.category, products: [] };
                    lists[currentListId].categories.push(category);
                    addedCategories++;
                }
                
                // Add product if not exists
                if (!category.products.find(p => p.name === prod.name)) {
                    category.products.push({
                        name: prod.name,
                        price: prod.price || 0,
                        store: prod.store || '',
                        barcode: '',
                        excluded: false,
                        quantity: 1
                    });
                    addedProducts++;
                }
            });

            saveData();
            renderCategories();
            switchTab('products');
            
            alert(`‚úÖ Template "${template.name}" aplicat cu succes!\n\nüì¶ ${addedProducts} produse noi adƒÉugate\nüìÅ ${addedCategories} categorii noi create`);
        }

        // ==================== PRODUCT MANAGEMENT ====================
        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            const categories = lists[currentListId].categories;
            
            if (!categories || categories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div class="empty-state-text">Nicio categorie<br>AdaugƒÉ prima categorie sau folose»ôte un template</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            let totalValue = 0;

            categories.forEach((category, catIndex) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                
                let categoryTotal = 0;
                let productCount = category.products.length;
                
                category.products.forEach(p => {
                    categoryTotal += (p.price || 0) * (p.quantity || 1);
                });
                
                totalValue += categoryTotal;
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'category-header';
                headerDiv.innerHTML = `
                    <div class="category-name">${category.name}</div>
                    <div class="category-stats">${productCount} prod.${settings.showPrices ? ` ‚Ä¢ ${categoryTotal.toFixed(2)} lei` : ''}</div>
                    <div class="category-controls">
                        ${catIndex > 0 ? `<button class="small-btn" onclick="moveCategory(${catIndex}, -1)">‚Üë</button>` : ''}
                        ${catIndex < categories.length - 1 ? `<button class="small-btn" onclick="moveCategory(${catIndex}, 1)">‚Üì</button>` : ''}
                        <button class="small-btn" onclick="deleteCategory(${catIndex})">üóëÔ∏è</button>
                    </div>
                `;
                
                const productsDiv = document.createElement('div');
                productsDiv.className = 'products-list';
                
                category.products.forEach((product, prodIndex) => {
                    // Filter by search query
                    if (searchQuery && !product.name.toLowerCase().includes(searchQuery)) {
                        return; // Skip this product
                    }
                    
                    const productDiv = document.createElement('div');
                    productDiv.className = 'product-item';
                    productDiv.draggable = true;
                    productDiv.dataset.catIndex = catIndex;
                    productDiv.dataset.prodIndex = prodIndex;
                    
                    const inCart = isInCart(category.name, product.name);
                    
                    // Highlight search term
                    let displayName = product.name;
                    if (searchQuery) {
                        const regex = new RegExp(`(${searchQuery})`, 'gi');
                        displayName = product.name.replace(regex, '<span class="highlight">$1</span>');
                    }
                    
                    productDiv.innerHTML = `
                        <input type="checkbox" class="product-checkbox" ${inCart ? 'checked' : ''} 
                               onchange="toggleProduct('${category.name}', '${product.name}', this.checked)">
                        <div class="product-info">
                            <div class="product-name">${displayName}</div>
                            <div class="product-meta">
                                ${settings.showPrices && product.price ? `<span class="product-price">${product.price.toFixed(2)} lei</span>` : ''}
                                ${product.store ? `<span class="product-store">${product.store}</span>` : ''}
                                ${product.barcode ? `<span class="product-barcode">${product.barcode}</span>` : ''}
                            </div>
                        </div>
                        <div class="product-actions">
                            <button class="action-btn" onclick="openEditProductModal(${catIndex}, ${prodIndex})" title="EditeazƒÉ">‚úèÔ∏è</button>
                            <button class="action-btn" onclick="openMoveProductModal(${catIndex}, ${prodIndex})" title="MutƒÉ">üìÅ</button>
                        </div>
                        <button class="delete-btn" onclick="deleteProduct(${catIndex}, ${prodIndex})">√ó</button>
                    `;
                    
                    // Drag & Drop
                    productDiv.addEventListener('dragstart', handleDragStart);
                    productDiv.addEventListener('dragover', handleDragOver);
                    productDiv.addEventListener('drop', handleDrop);
                    productDiv.addEventListener('dragend', handleDragEnd);
                    
                    productsDiv.appendChild(productDiv);
                });
                
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-secondary';
                addBtn.textContent = '+ AdaugƒÉ Produs';
                addBtn.onclick = () => openProductModal(catIndex);
                productsDiv.appendChild(addBtn);
                
                categoryDiv.appendChild(headerDiv);
                categoryDiv.appendChild(productsDiv);
                container.appendChild(categoryDiv);
            });
            
            updateStats();
            
            // Show/hide deselect all button in FAB menu based on cart content
            const deselectBtn = document.getElementById('deselectAllFabOption');
            if (deselectBtn) {
                const hasCartItems = lists[currentListId].shoppingCart && lists[currentListId].shoppingCart.length > 0;
                deselectBtn.style.display = hasCartItems ? 'flex' : 'none';
            }
            
            saveData();
        }

        // Drag & Drop handlers
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const fromCat = parseInt(draggedElement.dataset.catIndex);
                const fromProd = parseInt(draggedElement.dataset.prodIndex);
                const toCat = parseInt(this.dataset.catIndex);
                
                if (fromCat !== toCat) {
                    // Move product to different category
                    const product = lists[currentListId].categories[fromCat].products[fromProd];
                    lists[currentListId].categories[toCat].products.push(product);
                    lists[currentListId].categories[fromCat].products.splice(fromProd, 1);
                    renderCategories();
                }
            }
            
            this.classList.remove('drag-over');
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.product-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        // Move Product Modal
        window.openMoveProductModal = function(catIndex, prodIndex) {
            moveProductData = { catIndex, prodIndex };
            const select = document.getElementById('newCategorySelect');
            select.innerHTML = '';
            
            lists[currentListId].categories.forEach((cat, index) => {
                if (index !== catIndex) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = cat.name;
                    select.appendChild(option);
                }
            });
            
            document.getElementById('moveProductModal').classList.add('active');
        };

        window.closeMoveProductModal = function() {
            document.getElementById('moveProductModal').classList.remove('active');
            moveProductData = null;
        };

        window.confirmMoveProduct = function() {
            if (!moveProductData) return;
            
            const newCatIndex = parseInt(document.getElementById('newCategorySelect').value);
            const { catIndex, prodIndex } = moveProductData;
            
            const product = lists[currentListId].categories[catIndex].products[prodIndex];
            lists[currentListId].categories[newCatIndex].products.push(product);
            lists[currentListId].categories[catIndex].products.splice(prodIndex, 1);
            
            renderCategories();
            closeMoveProductModal();
        };

        // Product Modal
        let editingProduct = null; // Track if we're editing

        window.openProductModal = function(catIndex) {
            editingProduct = null; // Reset - we're adding new
            const modal = document.getElementById('productModal');
            const modalTitle = modal.querySelector('.modal-title');
            const select = document.getElementById('productCategory');
            const storeSelect = document.getElementById('productStore');
            
            modalTitle.textContent = 'AdaugƒÉ Produs';
            
            // Clear fields
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productQuantity').value = '1';
            document.getElementById('productBarcode').value = '';
            document.getElementById('productStore').value = '';
            document.getElementById('customStore').value = '';
            document.getElementById('customStoreGroup').style.display = 'none';
            
            select.innerHTML = '';
            lists[currentListId].categories.forEach((cat, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = cat.name;
                if (index === catIndex) option.selected = true;
                select.appendChild(option);
            });
            
            // Show/hide custom store input
            storeSelect.onchange = function() {
                const customGroup = document.getElementById('customStoreGroup');
                customGroup.style.display = this.value === 'Altul' ? 'block' : 'none';
            };
            
            modal.classList.add('active');
        };

        window.openEditProductModal = function(catIndex, prodIndex) {
            editingProduct = { catIndex, prodIndex }; // Track editing
            const modal = document.getElementById('productModal');
            const modalTitle = modal.querySelector('.modal-title');
            const product = lists[currentListId].categories[catIndex].products[prodIndex];
            
            modalTitle.textContent = 'EditeazƒÉ Produs';
            
            // Fill fields with existing data
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productPrice').value = product.price || '';
            document.getElementById('productQuantity').value = product.quantity || 1;
            document.getElementById('productBarcode').value = product.barcode || '';
            
            // Set store
            const storeSelect = document.getElementById('productStore');
            const storeValue = product.store || '';
            const isCustomStore = !['Kaufland', 'Lidl', 'Carrefour', 'Mega Image', 'Auchan', 'Penny', 'Profi', ''].includes(storeValue);
            
            if (isCustomStore && storeValue) {
                storeSelect.value = 'Altul';
                document.getElementById('customStore').value = storeValue;
                document.getElementById('customStoreGroup').style.display = 'block';
            } else {
                storeSelect.value = storeValue;
                document.getElementById('customStoreGroup').style.display = 'none';
            }
            
            // Set category
            const select = document.getElementById('productCategory');
            select.innerHTML = '';
            lists[currentListId].categories.forEach((cat, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = cat.name;
                if (index === catIndex) option.selected = true;
                select.appendChild(option);
            });
            
            // Show/hide custom store input
            storeSelect.onchange = function() {
                const customGroup = document.getElementById('customStoreGroup');
                customGroup.style.display = this.value === 'Altul' ? 'block' : 'none';
            };
            
            modal.classList.add('active');
        };

        window.closeProductModal = function() {
            document.getElementById('productModal').classList.remove('active');
            editingProduct = null;
        };

        window.addNewProduct = function() {
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value) || 0;
            const quantity = parseInt(document.getElementById('productQuantity').value) || 1;
            const catIndex = parseInt(document.getElementById('productCategory').value);
            let store = document.getElementById('productStore').value;
            const barcode = document.getElementById('productBarcode').value.trim();
            
            if (store === 'Altul') {
                store = document.getElementById('customStore').value.trim();
            }
            
            if (!name) {
                alert('Introdu numele produsului!');
                return;
            }
            
            const productData = {
                name: name,
                price: price,
                store: store,
                barcode: barcode,
                excluded: false,
                quantity: quantity
            };
            
            if (editingProduct) {
                // Edit existing product
                const { catIndex: oldCatIndex, prodIndex } = editingProduct;
                const oldProduct = lists[currentListId].categories[oldCatIndex].products[prodIndex];
                const oldName = oldProduct.name;
                const oldCategory = lists[currentListId].categories[oldCatIndex].name;
                
                // Update product
                lists[currentListId].categories[catIndex].products[prodIndex] = productData;
                
                // Update shopping cart if product is there
                lists[currentListId].shoppingCart.forEach(item => {
                    if (item.product === oldName && item.category === oldCategory) {
                        item.product = name;
                        item.price = price;
                        item.store = store;
                        item.quantity = quantity;
                    }
                });
            } else {
                // Add new product
                lists[currentListId].categories[catIndex].products.push(productData);
            }
            
            renderCategories();
            renderShoppingList();
            closeProductModal();
        };

        window.deleteProduct = function(catIndex, prodIndex) {
            if (confirm('»òtergi acest produs permanent?')) {
                const product = lists[currentListId].categories[catIndex].products[prodIndex];
                const categoryName = lists[currentListId].categories[catIndex].name;
                
                lists[currentListId].categories[catIndex].products.splice(prodIndex, 1);
                lists[currentListId].shoppingCart = lists[currentListId].shoppingCart.filter(item => 
                    !(item.product === product.name && item.category === categoryName)
                );
                
                renderCategories();
                renderShoppingList();
            }
        };

        window.deleteCategory = function(catIndex) {
            if (confirm('»òtergi aceastƒÉ categorie »ôi toate produsele?')) {
                const categoryName = lists[currentListId].categories[catIndex].name;
                lists[currentListId].shoppingCart = lists[currentListId].shoppingCart.filter(
                    item => item.category !== categoryName
                );
                lists[currentListId].categories.splice(catIndex, 1);
                renderCategories();
                renderShoppingList();
            }
        };

        window.moveCategory = function(catIndex, direction) {
            const categories = lists[currentListId].categories;
            const newIndex = catIndex + direction;
            if (newIndex >= 0 && newIndex < categories.length) {
                [categories[catIndex], categories[newIndex]] = [categories[newIndex], categories[catIndex]];
                renderCategories();
            }
        };

        // Category Modal
        window.openCategoryModal = function() {
            document.getElementById('categoryModal').classList.add('active');
        };

        window.closeCategoryModal = function() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('categoryName').value = '';
        };

        window.addNewCategory = function() {
            const name = document.getElementById('categoryName').value.trim();
            if (name) {
                lists[currentListId].categories.push({
                    name: name,
                    products: []
                });
                renderCategories();
                closeCategoryModal();
            }
        };

        // ==================== DESELECT ALL ====================
        window.deselectAllProducts = function() {
            const cart = lists[currentListId].shoppingCart || [];
            
            if (cart.length === 0) {
                return;
            }
            
            if (!confirm(`Deselectezi toate produsele din lista de cumpƒÉrƒÉturi?\n\nüì¶ ${cart.length} produse vor fi deselectate`)) {
                return;
            }
            
            // Clear the shopping cart
            lists[currentListId].shoppingCart = [];
            
            saveData();
            renderCategories();
            renderShoppingList();
            
            // Hide the deselect button in FAB menu
            const deselectBtn = document.getElementById('deselectAllFabOption');
            if (deselectBtn) {
                deselectBtn.style.display = 'none';
            }
            
            alert('‚úÖ Toate produsele au fost deselectate!');
        };

        // ==================== SHOPPING CART ====================
        function isInCart(categoryName, productName) {
            return lists[currentListId].shoppingCart.some(item => 
                item.product === productName && item.category === categoryName
            );
        }

        window.toggleProduct = function(categoryName, productName, isChecked) {
            const cart = lists[currentListId].shoppingCart;
            const index = cart.findIndex(item => 
                item.product === productName && item.category === categoryName
            );
            
            if (isChecked && index === -1) {
                // Find product details
                const category = lists[currentListId].categories.find(c => c.name === categoryName);
                const product = category?.products.find(p => p.name === productName);
                
                cart.push({
                    category: categoryName,
                    product: productName,
                    store: product?.store || '',
                    price: product?.price || 0,
                    quantity: product?.quantity || 1,
                    purchased: false
                });
            } else if (!isChecked && index !== -1) {
                cart.splice(index, 1);
            }
            
            renderShoppingList();
            updateShoppingStats();
            saveData();
        };

        function renderShoppingList() {
            const container = document.getElementById('shoppingList');
            const cart = lists[currentListId].shoppingCart;
            
            if (!cart || cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üõçÔ∏è</div>
                        <div class="empty-state-text">Lista ta de cumpƒÉrƒÉturi este goalƒÉ<br>SelecteazƒÉ produse din tab-ul Produse</div>
                    </div>
                `;
                updateShoppingStats();
                return;
            }

            container.innerHTML = '';
            
            // Filter by store if selected
            let displayCart = cart;
            if (selectedStoreFilter) {
                displayCart = cart.filter(item => item.store === selectedStoreFilter);
            }
            
            // Group by store
            const grouped = {};
            displayCart.forEach(item => {
                const store = item.store || 'FƒÉrƒÉ magazin';
                if (!grouped[store]) grouped[store] = [];
                grouped[store].push(item);
            });

            Object.keys(grouped).sort().forEach(store => {
                const storeDiv = document.createElement('div');
                storeDiv.className = 'store-section';
                
                let storeTotal = 0;
                grouped[store].forEach(item => {
                    storeTotal += (item.price || 0) * (item.quantity || 1);
                });
                
                const header = document.createElement('div');
                header.className = 'store-header';
                header.textContent = `${store} (${grouped[store].length} prod.)${settings.showPrices ? ` ‚Ä¢ ${storeTotal.toFixed(2)} lei` : ''}`;
                storeDiv.appendChild(header);
                
                grouped[store].forEach((item, idx) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shopping-item' + (item.purchased ? ' purchased' : '');
                    
                    const globalIndex = cart.findIndex(i => 
                        i.product === item.product && i.category === item.category
                    );
                    
                    itemDiv.innerHTML = `
                        <input type="checkbox" class="product-checkbox" ${item.purchased ? 'checked' : ''}
                               onchange="togglePurchased(${globalIndex}, this.checked)">
                        <div class="shopping-item-details">
                            <div class="shopping-item-name">${item.product}</div>
                            <div class="shopping-item-meta">
                                <span class="meta-tag" style="background: rgba(102, 126, 234, 0.1); color: var(--primary);">
                                    ${item.category}
                                </span>
                                ${settings.showPrices && item.price ? 
                                    `<span class="meta-tag" style="background: rgba(76, 175, 80, 0.1); color: var(--success);">
                                        ${((item.price || 0) * (item.quantity || 1)).toFixed(2)} lei
                                    </span>` : ''}
                            </div>
                        </div>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="adjustQuantity(${globalIndex}, -1)">-</button>
                            <span class="qty-display">${item.quantity || 1}</span>
                            <button class="qty-btn" onclick="adjustQuantity(${globalIndex}, 1)">+</button>
                        </div>
                    `;
                    
                    storeDiv.appendChild(itemDiv);
                });
                
                container.appendChild(storeDiv);
            });

            updateShoppingStats();
            renderStoreFilter();
            
            // Update deselect all button visibility in FAB menu
            const deselectBtn = document.getElementById('deselectAllFabOption');
            if (deselectBtn) {
                const hasCartItems = cart && cart.length > 0;
                deselectBtn.style.display = hasCartItems ? 'flex' : 'none';
            }
        }

        function renderStoreFilter() {
            const container = document.getElementById('storesFilter');
            const cart = lists[currentListId].shoppingCart;
            
            const stores = [...new Set(cart.map(item => item.store || 'FƒÉrƒÉ magazin'))];
            
            container.innerHTML = '';
            
            // All stores chip
            const allChip = document.createElement('div');
            allChip.className = 'store-chip' + (!selectedStoreFilter ? ' selected' : '');
            allChip.textContent = `Toate (${cart.length})`;
            allChip.onclick = () => {
                selectedStoreFilter = null;
                renderShoppingList();
            };
            container.appendChild(allChip);
            
            // Individual store chips
            stores.sort().forEach(store => {
                const count = cart.filter(item => (item.store || 'FƒÉrƒÉ magazin') === store).length;
                const chip = document.createElement('div');
                chip.className = 'store-chip' + (selectedStoreFilter === store ? ' selected' : '');
                chip.textContent = `${store} (${count})`;
                chip.onclick = () => {
                    selectedStoreFilter = store;
                    renderShoppingList();
                };
                container.appendChild(chip);
            });
        }

        window.togglePurchased = function(index, isPurchased) {
            const item = lists[currentListId].shoppingCart[index];
            item.purchased = isPurchased;
            
            if (isPurchased) {
                // Add to purchase history for AI
                purchaseHistory.push({
                    product: item.product,
                    category: item.category,
                    store: item.store,
                    price: item.price,
                    date: new Date().toISOString()
                });
            }
            
            renderShoppingList();
            saveData();
        };

        window.adjustQuantity = function(index, delta) {
            const item = lists[currentListId].shoppingCart[index];
            item.quantity = Math.max(1, (item.quantity || 1) + delta);
            renderShoppingList();
            saveData();
        };

        function updateStats() {
            const categories = lists[currentListId].categories || [];
            let totalProducts = 0;
            let totalValue = 0;
            
            categories.forEach(cat => {
                totalProducts += cat.products.length;
                cat.products.forEach(p => {
                    totalValue += (p.price || 0) * (p.quantity || 1);
                });
            });
            
            // Update header stats
            document.getElementById('totalProductsHeader').textContent = totalProducts;
            document.getElementById('categoriesCountHeader').textContent = categories.length;
            
            if (settings.showPrices) {
                document.getElementById('totalValueHeader').textContent = totalValue.toFixed(0);
            } else {
                document.getElementById('totalValueHeader').textContent = '‚Äî';
            }
        }

        function updateShoppingStats() {
            const cart = lists[currentListId].shoppingCart || [];
            const purchased = cart.filter(item => item.purchased).length;
            const stores = [...new Set(cart.map(item => item.store || 'FƒÉrƒÉ magazin'))].length;
            
            let total = 0;
            cart.forEach(item => {
                total += (item.price || 0) * (item.quantity || 1);
            });
            
            document.getElementById('totalItems').textContent = cart.length;
            document.getElementById('purchasedItems').textContent = purchased;
            document.getElementById('remainingItems').textContent = cart.length - purchased;
            document.getElementById('storesCount').textContent = stores;
            document.getElementById('cartBadge').textContent = cart.length;
            
            // Show/hide budget based on settings
            const budgetCard = document.querySelector('.budget-card');
            if (settings.showPrices) {
                document.getElementById('totalBudget').textContent = total.toFixed(2) + ' lei';
                const budgetLimit = 500;
                const progress = Math.min((total / budgetLimit) * 100, 100);
                document.getElementById('budgetProgress').style.width = progress + '%';
                budgetCard.style.display = 'flex';
            } else {
                budgetCard.style.display = 'none';
            }
        }

        // ==================== TAB SWITCHING ====================
        window.switchTab = function(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById(`${tab}Tab`).style.display = 'block';
            
            // Show/hide complete shopping button only in shopping tab
            const completeBtn = document.getElementById('completeShoppingBtn');
            if (completeBtn) {
                completeBtn.style.display = tab === 'shopping' ? 'block' : 'none';
            }
            
            // Update deselect all button visibility in FAB menu
            const deselectBtn = document.getElementById('deselectAllFabOption');
            if (deselectBtn) {
                const hasCartItems = lists[currentListId].shoppingCart && lists[currentListId].shoppingCart.length > 0;
                deselectBtn.style.display = hasCartItems ? 'flex' : 'none';
            }
            
            // Render history when switching to history tab
            if (tab === 'history') {
                renderHistory();
            }
            
            // Hide FAB menu when switching tabs
            document.getElementById('fabMenu').classList.remove('active');
            document.getElementById('mainFab').classList.remove('active');
        };

        // ==================== FAB MENU ====================
        window.toggleFabMenu = function() {
            const menu = document.getElementById('fabMenu');
            const fab = document.getElementById('mainFab');
            menu.classList.toggle('active');
            fab.classList.toggle('active');
        };

        // ==================== SETTINGS ====================
        window.openSettingsModal = function() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('darkModeToggle').checked = settings.darkMode;
            document.getElementById('aiToggle').checked = settings.aiEnabled;
            document.getElementById('notificationsToggle').checked = settings.notifications;
            document.getElementById('pricesToggle').checked = settings.showPrices;
        };

        window.closeSettingsModal = function() {
            document.getElementById('settingsModal').classList.remove('active');
        };

        window.toggleDarkMode = function() {
            settings.darkMode = document.getElementById('darkModeToggle').checked;
            document.documentElement.setAttribute('data-theme', settings.darkMode ? 'dark' : 'light');
            saveSettings();
        };

        window.toggleAI = function() {
            settings.aiEnabled = document.getElementById('aiToggle').checked;
            if (settings.aiEnabled) {
                showAISuggestions();
            } else {
                document.getElementById('aiSuggestionsPanel').style.display = 'none';
            }
            saveSettings();
        };

        window.toggleNotifications = async function() {
            settings.notifications = document.getElementById('notificationsToggle').checked;
            if (settings.notifications && 'Notification' in window) {
                const permission = await Notification.requestPermission();
                settings.notifications = permission === 'granted';
                document.getElementById('notificationsToggle').checked = settings.notifications;
            }
            saveSettings();
        };

        window.togglePrices = function() {
            settings.showPrices = document.getElementById('pricesToggle').checked;
            renderCategories();
            renderShoppingList();
            saveSettings();
        };

        window.exportData = function() {
            const dataStr = JSON.stringify({
                lists: lists,
                history: purchaseHistory,
                settings: settings
            }, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `lista-smart-backup-${Date.now()}.json`;
            link.click();
        };

        window.importData = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (imported.lists) lists = imported.lists;
                        if (imported.history) purchaseHistory = imported.history;
                        if (imported.settings) settings = imported.settings;
                        saveData();
                        saveSettings();
                        renderCategories();
                        renderShoppingList();
                        alert('‚úÖ Date importate cu succes!');
                    } catch (err) {
                        alert('‚ùå Eroare la import! VerificƒÉ fi»ôierul.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        window.exportProducts = function() {
            const currentList = lists[currentListId];
            const productsData = {
                listName: currentList.name,
                exportDate: new Date().toISOString(),
                categories: currentList.categories.map(cat => ({
                    name: cat.name,
                    products: cat.products.map(prod => ({
                        name: prod.name,
                        price: prod.price || 0,
                        store: prod.store || '',
                        barcode: prod.barcode || '',
                        quantity: prod.quantity || 1,
                        excluded: prod.excluded || false
                    }))
                }))
            };
            
            const dataStr = JSON.stringify(productsData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `produse-${currentList.name}-${Date.now()}.json`;
            link.click();
            
            alert(`‚úÖ Lista de produse exportatƒÉ!\n\n${getTotalProductsCount()} produse din ${currentList.categories.length} categorii`);
        };

        window.importProducts = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        
                        if (!imported.categories || !Array.isArray(imported.categories)) {
                            alert('‚ùå Fi»ôier invalid! Nu con»õine categorii.');
                            return;
                        }
                        
                        let addedProducts = 0;
                        let addedCategories = 0;
                        
                        // Import categories and products
                        imported.categories.forEach(importCat => {
                            // Find or create category
                            let category = lists[currentListId].categories.find(c => c.name === importCat.name);
                            
                            if (!category) {
                                category = { name: importCat.name, products: [] };
                                lists[currentListId].categories.push(category);
                                addedCategories++;
                            }
                            
                            // Add products
                            importCat.products.forEach(importProd => {
                                // Check if product already exists
                                const exists = category.products.find(p => p.name === importProd.name);
                                
                                if (!exists) {
                                    category.products.push({
                                        name: importProd.name,
                                        price: importProd.price || 0,
                                        store: importProd.store || '',
                                        barcode: importProd.barcode || '',
                                        quantity: importProd.quantity || 1,
                                        excluded: importProd.excluded || false
                                    });
                                    addedProducts++;
                                }
                            });
                        });
                        
                        saveData();
                        renderCategories();
                        renderShoppingList();
                        
                        alert(`‚úÖ Import complet!\n\n` +
                              `üì¶ ${addedProducts} produse noi adƒÉugate\n` +
                              `üìÅ ${addedCategories} categorii noi create\n\n` +
                              `(Produsele existente au fost pƒÉstrate)`);
                              
                    } catch (err) {
                        alert('‚ùå Eroare la import! VerificƒÉ fi»ôierul.\n\n' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        function getTotalProductsCount() {
            let count = 0;
            lists[currentListId].categories.forEach(cat => {
                count += cat.products.length;
            });
            return count;
        }

        window.clearHistory = function() {
            if (confirm('»òtergi tot istoricul de cumpƒÉrƒÉturi? (nu afecteazƒÉ listele actuale)')) {
                purchaseHistory = [];
                saveData();
                alert('‚úÖ Istoric »ôters!');
            }
        };

        // ==================== SHARE ====================
        let originalShareUrl = '';
        
        window.openShareModal = function() {
            const listData = encodeURIComponent(JSON.stringify(lists[currentListId]));
            const shareUrl = `${window.location.origin}${window.location.pathname}?list=${listData}`;
            originalShareUrl = shareUrl;
            document.getElementById('shareLink').value = shareUrl;
            document.getElementById('shareModal').classList.add('active');
            
            // Reset shorten button and status
            const shortenBtn = document.getElementById('shortenBtn');
            shortenBtn.disabled = false;
            shortenBtn.innerHTML = '‚úÇÔ∏è ScurteazƒÉ Link';
            document.getElementById('shortenStatus').style.display = 'none';
        };

        window.closeShareModal = function() {
            document.getElementById('shareModal').classList.remove('active');
        };

        window.copyShareLink = function() {
            const input = document.getElementById('shareLink');
            input.select();
            input.setSelectionRange(0, 99999); // For mobile
            
            try {
                document.execCommand('copy');
                const status = document.getElementById('shortenStatus');
                status.textContent = '‚úÖ Link copiat √Æn clipboard!';
                status.style.color = 'var(--success)';
                status.style.display = 'block';
                
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            } catch (err) {
                alert('Eroare la copiere. Te rog copiazƒÉ manual linkul.');
            }
        };

        window.shortenLink = async function() {
            const shortenBtn = document.getElementById('shortenBtn');
            const status = document.getElementById('shortenStatus');
            
            // Disable button and show loading
            shortenBtn.disabled = true;
            shortenBtn.innerHTML = '‚è≥ Se scurteazƒÉ...';
            status.textContent = '‚è≥ Se genereazƒÉ link scurt...';
            status.style.color = 'var(--info)';
            status.style.display = 'block';
            
            try {
                // Use TinyURL API (free, no API key needed)
                const longUrl = encodeURIComponent(originalShareUrl);
                const response = await fetch(`https://tinyurl.com/api-create.php?url=${longUrl}`);
                
                if (!response.ok) {
                    throw new Error('Serviciul de scurtare nu este disponibil');
                }
                
                const shortUrl = await response.text();
                
                // Update the input with short URL
                document.getElementById('shareLink').value = shortUrl;
                
                // Show success message
                status.textContent = `‚úÖ Link scurtat cu succes! (${originalShareUrl.length} ‚Üí ${shortUrl.length} caractere)`;
                status.style.color = 'var(--success)';
                shortenBtn.innerHTML = '‚úÖ Link Scurtat';
                
                // Auto-copy to clipboard
                const input = document.getElementById('shareLink');
                input.select();
                try {
                    document.execCommand('copy');
                    status.textContent += ' ‚Ä¢ Copiat automat!';
                } catch (e) {
                    // Silent fail
                }
                
            } catch (error) {
                status.textContent = '‚ùå Eroare la scurtarea linkului. √éncearcƒÉ din nou sau folose»ôte linkul lung.';
                status.style.color = 'var(--danger)';
                shortenBtn.disabled = false;
                shortenBtn.innerHTML = '‚úÇÔ∏è √éncearcƒÉ din nou';
                
                console.error('Error shortening URL:', error);
            }
        };

        window.shareViaWhatsApp = function() {
            const link = document.getElementById('shareLink').value;
            const message = `üõí Vezi lista mea de cumpƒÉrƒÉturi Smart:\n\n${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        };

        window.shareViaNative = async function() {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: lists[currentListId].name,
                        text: 'Vezi lista mea de cumpƒÉrƒÉturi',
                        url: document.getElementById('shareLink').value
                    });
                } catch (err) {
                    // Copy link instead
                    copyShareLink();
                }
            } else {
                // Fallback to copy
                copyShareLink();
            }
        };

        // ==================== STORAGE ====================
        function saveData() {
            localStorage.setItem('shoppingLists', JSON.stringify(lists));
            localStorage.setItem('currentListId', currentListId);
            localStorage.setItem('purchaseHistory', JSON.stringify(purchaseHistory));
            localStorage.setItem('shoppingTrips', JSON.stringify(shoppingTrips)); // NEW
        }

        function saveSettings() {
            localStorage.setItem('settings', JSON.stringify(settings));
        }

        function loadData() {
            const savedLists = localStorage.getItem('shoppingLists');
            const savedListId = localStorage.getItem('currentListId');
            const savedSettings = localStorage.getItem('settings');
            const savedHistory = localStorage.getItem('purchaseHistory');
            const savedTrips = localStorage.getItem('shoppingTrips'); // NEW
            
            if (savedLists) lists = JSON.parse(savedLists);
            if (savedListId) currentListId = savedListId;
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                document.documentElement.setAttribute('data-theme', settings.darkMode ? 'dark' : 'light');
            }
            if (savedHistory) purchaseHistory = JSON.parse(savedHistory);
            if (savedTrips) shoppingTrips = JSON.parse(savedTrips); // NEW
            
            // Check for shared list in URL
            const urlParams = new URLSearchParams(window.location.search);
            const sharedList = urlParams.get('list');
            if (sharedList) {
                try {
                    const imported = JSON.parse(decodeURIComponent(sharedList));
                    const id = Date.now().toString();
                    lists[id] = imported;
                    currentListId = id;
                    saveData();
                    window.history.replaceState({}, '', window.location.pathname);
                } catch (err) {
                    console.log('Invalid shared list');
                }
            }
            
            document.getElementById('currentListName').textContent = lists[currentListId].name;
        }

        // ==================== SHOPPING TRIP TRACKING ====================
        window.completeShoppingTrip = function() {
            const cart = lists[currentListId].shoppingCart || [];
            const purchasedItems = cart.filter(item => item.purchased);
            
            if (purchasedItems.length === 0) {
                alert('‚ùå Niciun produs marcat ca fiind cumpƒÉrat!\n\nBifeazƒÉ produsele pe care le-ai cumpƒÉrat √Ænainte de a finaliza.');
                return;
            }
            
            // Calculate total
            let totalCost = 0;
            purchasedItems.forEach(item => {
                totalCost += (item.price || 0) * (item.quantity || 1);
            });
            
            // Group by category for better organization
            const categorizedProducts = {};
            purchasedItems.forEach(item => {
                if (!categorizedProducts[item.category]) {
                    categorizedProducts[item.category] = [];
                }
                categorizedProducts[item.category].push({
                    name: item.product,
                    price: item.price || 0,
                    quantity: item.quantity || 1,
                    store: item.store || 'FƒÉrƒÉ magazin'
                });
            });
            
            const categoriesCount = Object.keys(categorizedProducts).length;
            
            if (!confirm(`Finalizezi cumpƒÉrƒÉturile?\n\nüì¶ ${purchasedItems.length} produse cumpƒÉrate\nüìÅ ${categoriesCount} categorii\nüí∞ ${totalCost.toFixed(2)} lei\n\nProdusele bifate vor fi »ôterse din listƒÉ.`)) {
                return;
            }
            
            // Create shopping trip record
            const trip = {
                id: Date.now(),
                date: new Date().toISOString(),
                listName: lists[currentListId].name,
                products: Object.keys(categorizedProducts).map(category => ({
                    category: category,
                    products: categorizedProducts[category]
                })),
                totalCost: totalCost,
                totalItems: purchasedItems.length,
                categoriesCount: categoriesCount
            };
            
            // Add to shopping trips history
            shoppingTrips.unshift(trip);
            
            // Remove purchased items from cart
            lists[currentListId].shoppingCart = cart.filter(item => !item.purchased);
            
            saveData();
            renderShoppingList();
            
            alert(`‚úÖ CumpƒÉrƒÉturi finalizate!\n\nüìä Po»õi vedea detaliile √Æn tab-ul "Istoric"`);
        };

        window.filterHistory = function(period) {
            currentHistoryFilter = period;
            
            // Update active filter tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderHistory();
        };

        function renderHistory() {
            const container = document.getElementById('historyList');
            let filteredTrips = [...shoppingTrips];
            
            // Apply filter
            const now = new Date();
            if (currentHistoryFilter === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredTrips = filteredTrips.filter(trip => new Date(trip.date) >= weekAgo);
            } else if (currentHistoryFilter === 'month') {
                const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                filteredTrips = filteredTrips.filter(trip => new Date(trip.date) >= monthAgo);
            } else if (currentHistoryFilter === 'year') {
                const yearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                filteredTrips = filteredTrips.filter(trip => new Date(trip.date) >= yearAgo);
            }
            
            if (filteredTrips.length === 0) {
                container.innerHTML = `
                    <div class="empty-history">
                        <div class="empty-history-icon">üìä</div>
                        <div class="empty-state-text" style="font-size: 1.2em; margin-bottom: 10px;">Niciun istoric</div>
                        <div class="empty-state-text" style="font-size: 0.9em;">
                            FinalizeazƒÉ prima turƒÉ de cumpƒÉrƒÉturi pentru a vedea istoricul aici
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredTrips.forEach(trip => {
                const date = new Date(trip.date);
                const dateStr = date.toLocaleDateString('ro-RO', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                });
                const timeStr = date.toLocaleTimeString('ro-RO', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <div>
                                <div class="history-date">${dateStr}</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">
                                    üïê ${timeStr}
                                </div>
                            </div>
                            <div class="history-total">${trip.totalCost.toFixed(2)} lei</div>
                        </div>
                        <div class="history-stats">
                            <div class="history-stat">
                                <div class="history-stat-number">${trip.totalItems}</div>
                                <div class="history-stat-label">Produse</div>
                            </div>
                            <div class="history-stat">
                                <div class="history-stat-number">${trip.categoriesCount}</div>
                                <div class="history-stat-label">Categorii</div>
                            </div>
                            <div class="history-stat">
                                <div class="history-stat-number">${(trip.totalCost / trip.totalItems).toFixed(2)}</div>
                                <div class="history-stat-label">LEI/produs</div>
                            </div>
                        </div>
                        <div class="history-products">
                            ${trip.products.map(cat => `
                                <div class="history-category">
                                    <div class="history-category-title">üìÅ ${cat.category}</div>
                                    ${cat.products.map(prod => `
                                        <div class="history-product">
                                            <div class="history-product-name">
                                                ${prod.name} ${prod.quantity > 1 ? '√ó ' + prod.quantity : ''}
                                                ${prod.store && prod.store !== 'FƒÉrƒÉ magazin' ? 
                                                    `<span style="font-size: 0.85em; opacity: 0.7;"> ‚Ä¢ ${prod.store}</span>` : ''}
                                            </div>
                                            <div class="history-product-price">
                                                ${((prod.price || 0) * (prod.quantity || 1)).toFixed(2)} lei
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('')}
                        </div>
                        <div class="history-actions">
                            <button class="btn-icon btn-delete" onclick="deleteTrip(${trip.id})">
                                üóëÔ∏è »òterge
                            </button>
                            <button class="btn-icon btn-reorder" onclick="reorderFromTrip(${trip.id})">
                                üîÑ ComandƒÉ din nou
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        window.deleteTrip = function(tripId) {
            if (!confirm('»òtergi aceastƒÉ √Ænregistrare din istoric?')) {
                return;
            }
            
            shoppingTrips = shoppingTrips.filter(trip => trip.id !== tripId);
            saveData();
            renderHistory();
        };

        window.reorderFromTrip = function(tripId) {
            const trip = shoppingTrips.find(t => t.id === tripId);
            if (!trip) return;
            
            if (!confirm(`Adaugi produsele din aceastƒÉ turƒÉ √Æn lista ta de cumpƒÉrƒÉturi?\n\nüì¶ ${trip.totalItems} produse vor fi adƒÉugate`)) {
                return;
            }
            
            let addedCount = 0;
            
            trip.products.forEach(catData => {
                catData.products.forEach(prod => {
                    // Find the category in products tab
                    let category = lists[currentListId].categories.find(c => c.name === catData.category);
                    
                    if (category) {
                        // Find the product in that category
                        let product = category.products.find(p => p.name === prod.name);
                        
                        if (product) {
                            // Add to cart if not already there
                            const existsInCart = lists[currentListId].shoppingCart.some(
                                item => item.product === prod.name && item.category === catData.category
                            );
                            
                            if (!existsInCart) {
                                lists[currentListId].shoppingCart.push({
                                    product: prod.name,
                                    category: catData.category,
                                    price: product.price || prod.price,
                                    store: product.store || prod.store,
                                    quantity: prod.quantity,
                                    purchased: false
                                });
                                addedCount++;
                            }
                        }
                    }
                });
            });
            
            saveData();
            switchTab('shopping');
            renderShoppingList();
            
            alert(`‚úÖ ${addedCount} produse adƒÉugate √Æn lista de cumpƒÉrƒÉturi!\n\nVezi tab-ul "Lista" pentru detalii.`);
        };

        // ==================== INITIALIZATION ====================
        loadData();
        renderCategories();
        renderShoppingList();
        renderTemplates();
        
        // Show AI suggestions after 2 seconds
        setTimeout(() => {
            if (settings.aiEnabled) {
                showAISuggestions();
            }
        }, 2000);

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>